#!/usr/bin/env Rscript

# ---- remove old generated markdown to avoid conflicts ----
md_files <- list.files("content/post", pattern = "^index\\.md$", recursive = TRUE, full.names = TRUE)
if (length(md_files) > 0) {
  message("Removing ", length(md_files), " old generated index.md files...")
  file.remove(md_files)
} else {
  message("No previously generated index.md files found.")
}

# ---- render Rmd -> md ----
rmd_files <- list.files("content/post", pattern = "^index\\.Rmd$", recursive = TRUE, full.names = TRUE)
if (length(rmd_files) == 0) {
  message("No index.Rmd files found under content/post. Nothing to render.")
} else {
  message("Found ", length(rmd_files), " index.Rmd files. Rendering to Markdown...")
  for (rmd in rmd_files) {
    message(" -> rendering: ", rmd)
    tryCatch({
      rmarkdown::render(input = rmd,
                        output_format = rmarkdown::md_document(
                          variant = "gfm",
                          preserve_yaml = TRUE),
                        encoding = "UTF-8",
                        quiet = FALSE)
    }, error = function(e) {
      message("ERROR rendering ", rmd, ": ", conditionMessage(e))
      stop("Aborting due to render error.")
    })
  }
}

# ---- run hugo -D to build public/ ----
message("Running Hugo (hugo -D)...")
hugo_out <- tryCatch({
  system2("hugo", args = c("-D"), stdout = TRUE, stderr = TRUE)
}, error = function(e) {
  stop("Failed to execute Hugo: ", conditionMessage(e))
})
cat(hugo_out, sep = "\n")

message("Hugo completed successfully. public/ should be up to date.")

# ---- optional: Netlify deploy if env vars available ----
site_id <- Sys.getenv("NETLIFY_SITE_ID")
auth_token <- Sys.getenv("NETLIFY_AUTH_TOKEN")
if (nzchar(site_id) && nzchar(auth_token)) {
  message("Deploying public/ to Netlify (site=", site_id, ")...")
  netlify_res <- system2("netlify", args = c("deploy", "--prod",
                                             paste0("--dir=", normalizePath("public")),
                                             paste0("--site=", site_id),
                                             paste0("--auth=", auth_token)),
                         stdout = TRUE, stderr = TRUE)
  cat(netlify_res, sep = "\n")
  message("Netlify deploy finished.")
} else {
  message("NETLIFY_SITE_ID/AUTH_TOKEN not set or netlify CLI missing â€” skipping deploy.")
}

message("Done.")
